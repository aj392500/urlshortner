AWSTemplateFormatVersion: '2010-09-09'
Description: 'URL Shortener Infrastructure with EC2 and Security Group'

Parameters:
  InstanceType:
    Description: EC2 instance type
    Type: String
    Default: t2.micro
    AllowedValues: 
      - t2.micro
      - t2.small
      - t2.medium

  KeyName:
    Description: Name of an existing EC2 KeyPair
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Must be the name of an existing EC2 KeyPair

Resources:
  URLShortenerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH access
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 5000
          ToPort: 5000
          CidrIp: 0.0.0.0/0

  URLShortenerEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      SecurityGroups: 
        - !Ref URLShortenerSecurityGroup
      KeyName: !Ref KeyName
      ImageId: ami-0c55b159cbfafe1f0  # Amazon Linux 2 AMI (adjust for your region)
      UserData:
        Fn::Base64: 
          !Sub |
            #!/bin/bash
            yum update -y
            yum install -y python3 python3-pip
            pip3 install flask
            
            # Create application directory
            mkdir -p /opt/url-shortener
            cd /opt/url-shortener
            
            # Download application files (you would replace with your actual source repository)
            wget https://github.com/aj392500/urlshortner/blob/main/url-shortener-app.py
            wget https://your-source-repository.com/templates/index.html
            
            # Set up and run application
            python3 url_shortener.py &

Outputs:
  InstancePublicDNS:
    Description: Public DNS of the newly created EC2 instance
    Value: !GetAtt URLShortenerEC2Instance.PublicDnsName
